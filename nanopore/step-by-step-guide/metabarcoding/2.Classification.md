## 1. Prepare reference database

The next step is to obtain a reference database of 18S sequences for phytoplankton. This can be done by searching public databases such as NCBI GenBank, PR2 or SILVA, or by creating a custom database using reference sequences obtained from previous studies. In this case, we use PR2 directly.

Download the PR2 reference database in fasta format from the PR2 website and save it as "pr2.fasta" in the current directory.

```
wget https://github.com/pr2database/pr2database/releases/download/v4.14.0/pr2_version_4.14.0_SSU_mothur.fasta.gz
```

The filtered reads can be aligned to the reference database using Minimap2, but before that we need to create the minimap2 index from the PR2 reference database, install minimap2 if not already installed.

```
gzip -cd pr2_version_4.14.0_SSU_mothur.fasta.gz | minimap2 -d pr2.mmi -
```

You will have a file `pr2.mmi` in current directory and see something like this in the console if everything goes well:

```
$ gzip -cd pr2_version_4.14.0_SSU_mothur.fasta.gz | minimap2 -d pr2.mmi -
[M::mm_idx_gen::5.381*1.33] collected minimizers
[M::mm_idx_gen::7.152*1.74] sorted minimizers
[M::main::7.422*1.71] loaded/built the index for 197602 target sequence(s)
[M::mm_idx_stat] kmer size: 15; skip: 10; is_hpc: 0; #seq: 197602
[M::mm_idx_stat::7.455*1.71] distinct minimizers: 2686938 (54.99% are singletons); average occurrences: 19.292; average spacing: 5.431
[M::main] Version: 2.17-r941
[M::main] CMD: minimap2 -d pr2.mmi -
[M::main] Real time: 7.535 sec; CPU: 12.826 sec; Peak RSS: 1.543 GB
```

## 2.Alignment

```
# Create a list of input files
FILES=/data/merged/*.fastq.gz

# Loop over the input files and run the alignment for each file
for file in $FILES
do
  # Construct the output BAM file name based on the input file name
  output=$(basename $file .fastq.gz).bam

  # Align the reads to the PR2 reference database and save the output to a BAM file
  minimap2 -a -t 8 -x map-ont -N 50 -d pr2.mmi $file | samtools view -Sb - > $output
done
```
<details>
  <summary>Click to expand</summary>
  
  -ax map-ont: This is an option to specify the mapping mode used by minimap2. In this case, map-ont specifies that the input data is long-read Nanopore or PacBio sequencing data.
  -t 8: This option specifies the number of threads to use for the minimap2 alignment. In this case, 8 threads are used, which can help speed up the alignment process on a multi-core CPU.
  -N 50: This option sets the minimap2 alignment score threshold. Alignments with a score lower than 50 are considered low quality and discarded.
  -x pr2.mmi: This option specifies the path to the minimap2 index file (pr2.mmi) that is used for the alignment.

  samtools view: This is a command from the samtools software suite, which is used for manipulating and analyzing SAM/BAM files.
  -Sb: These options specify the output format (-b for binary BAM format) and input format (-S for SAM format).
  
</details>

Taxonomic classification: The aligned reads can be assigned taxonomic classifications based on the reference database using software such as Kraken2 or Kaiju. These programs use a database of reference sequences and a taxonomic tree to assign taxonomic classifications to the reads.

